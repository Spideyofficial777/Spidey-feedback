<!-- Quick Feedback Modal Component -->
<div id="quick-feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" onclick="closeQuickFeedbackModal(event)">
    <div class="bg-white rounded-2xl max-w-lg w-full p-6 transform transition-all duration-300 modal-content" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Quick Feedback</h3>
            <button onclick="closeQuickFeedbackModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form action="{{ url_for('feedback.submit') }}" method="POST" class="space-y-4" id="modal-feedback-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- Honeypot field -->
            <input type="text" name="website" style="display: none;" tabindex="-1">
            
            <!-- Security Token Animation -->
            <div class="security-badge flex items-center bg-blue-50 p-3 rounded-lg mb-4">
                <div class="w-5 h-5 bg-blue-500 rounded-full mr-2 animate-pulse"></div>
                <span class="text-sm text-blue-700">Secure connection encrypted</span>
            </div>
            
            <!-- Dynamic Form Fields -->
            {% for field in form_fields %}
                {% if field.field_type == 'text' %}
                    <div class="form-group">
                        <label for="modal_{{ field.field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ field.field_label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <input type="text" 
                               name="{{ field.field_name }}" 
                               id="modal_{{ field.field_name }}"
                               {% if field.is_required %}required{% endif %}
                               {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}
                               class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                
                {% elif field.field_type == 'email' %}
                    <div class="form-group">
                        <label for="modal_{{ field.field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ field.field_label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <input type="email" 
                               name="{{ field.field_name }}" 
                               id="modal_{{ field.field_name }}"
                               {% if field.is_required %}required{% endif %}
                               {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}
                               class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                
                {% elif field.field_type == 'textarea' %}
                    <div class="form-group">
                        <label for="modal_{{ field.field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ field.field_label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <textarea name="{{ field.field_name }}" 
                                  id="modal_{{ field.field_name }}" 
                                  rows="3"
                                  {% if field.is_required %}required{% endif %}
                                  {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}
                                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all duration-200"></textarea>
                    </div>
                
                {% elif field.field_type == 'rating' %}
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ field.field_label }}
                            {% if field.is_required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <div class="star-rating flex space-x-1">
                            <input type="hidden" name="{{ field.field_name }}" value="0">
                            {% for i in range(1, 6) %}
                                <span class="star text-2xl text-gray-300 hover:text-yellow-400 cursor-pointer transition-colors" data-rating="{{ i }}">
                                    â˜…
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            
            <div class="flex space-x-3 mt-6">
                <button type="button" onclick="closeQuickFeedbackModal()"
                        class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200">
                    Cancel
                </button>
                <button type="submit" id="modal-submit-btn"
                        class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-all duration-200 relative overflow-hidden">
                    <span class="relative z-10">Send Feedback</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-700 to-purple-700 opacity-0 hover:opacity-100 transition-opacity duration-200"></div>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    #quick-feedback-modal {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    #quick-feedback-modal:not(.hidden) {
        opacity: 1;
    }
    
    .modal-content {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    #quick-feedback-modal:not(.hidden) .modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
    
    .form-group {
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    #quick-feedback-modal:not(.hidden) .form-group {
        opacity: 1;
        transform: translateY(0);
    }
    
    .form-group:nth-child(1) { transition-delay: 0.1s; }
    .form-group:nth-child(2) { transition-delay: 0.2s; }
    .form-group:nth-child(3) { transition-delay: 0.3s; }
    .form-group:nth-child(4) { transition-delay: 0.4s; }
    .form-group:nth-child(5) { transition-delay: 0.5s; }
    
    .star-rating .star {
        transition: all 0.2s ease;
    }
    
    .star-rating .star:hover,
    .star-rating .star.active {
        transform: scale(1.2);
    }
    
    #modal-submit-btn:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: all 0.5s ease;
    }
    
    #modal-submit-btn:hover:before {
        left: 100%;
    }
</style>

<script>
function openQuickFeedbackModal() {
    const modal = document.getElementById('quick-feedback-modal');
    modal.classList.remove('hidden');
    
    // Initialize star ratings in modal
    initModalStarRating();
    
    // Add animation delay for form groups
    setTimeout(() => {
        const formGroups = modal.querySelectorAll('.form-group');
        formGroups.forEach((group, index) => {
            group.style.transitionDelay = `${0.1 + (index * 0.1)}s`;
        });
    }, 50);
}

function closeQuickFeedbackModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    const modal = document.getElementById('quick-feedback-modal');
    modal.classList.add('hidden');
}

function initModalStarRating() {
    const ratings = document.querySelectorAll('#quick-feedback-modal .star-rating');
    
    ratings.forEach(rating => {
        const stars = rating.querySelectorAll('.star');
        const input = rating.querySelector('input[type="hidden"]');
        let currentRating = 0;

        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                currentRating = index + 1;
                input.value = currentRating;
                updateModalStars(stars, currentRating);
            });

            star.addEventListener('mouseenter', () => {
                updateModalStars(stars, index + 1);
            });
        });

        rating.addEventListener('mouseleave', () => {
            updateModalStars(stars, currentRating);
        });
    });
}

function updateModalStars(stars, rating) {
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active', 'text-yellow-400');
            star.classList.remove('text-gray-300');
        } else {
            star.classList.remove('active', 'text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
}

// Add form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('modal-feedback-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('modal-submit-btn');
            submitBtn.innerHTML = '<span class="relative z-10">Sending...</span>';
            submitBtn.disabled = true;
            
            // Simulate encryption process
            setTimeout(() => {
                // Form will submit normally after this
            }, 1000);
        });
    }
});
</script>